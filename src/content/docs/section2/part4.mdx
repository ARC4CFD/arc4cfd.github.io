---
title: 'Pre-processing'
---

import Box from '../../../components/Box.astro';
import Caption from '../../../components/Caption.astro';
import CustomAside from '../../../components/CustomAside.astro';
import { Tabs, TabItem } from '@astrojs/starlight/components';
import CodeFetch from '../../../components/CodeFetch.astro';

import { YouTube } from '@astro-community/astro-embed-youtube';

:::note[Learning Objectives]
By the end of this section, you should be able to:
1. Construct a mesh and send to HPC
2. Configure numerical setup with HPC consideration
3. Understand interconnectivity among CFD tools
:::


## Preprocessing for CFD simulations: Overview
The pre-processing step is not specific to the CFD workflow on HPC systems. In fact, many of these steps such as geometry generation, mesh creation, and input file setup are integral steps to any CFD simulation. Out of completness, we present them main steps as well specific considerations for pre-processing when useing  HPC.


![HPCcompromise.](../../../assets/figs_section2/ARC4CFD_workflow_PREPROC.png "Process simulations of the CFD simulation")


## Preprocessing main steps and toolsets
The steps for preprocessing CFD simulations are very broadly divided along with the toolset used:
1. Construct the geometry
2. Discretize the fluid domain
3. Setup the simulation
These steps are broken down in following but first, we will have a brief overview of the toolsets that can be used for pre-processing CFD simulations.


### Toolsets
Many tools are available to complete the pre-processing step. Here, we provide a brief overview of some of the tools available. Please keep in mind that some CFD solvers have geometry and meshing capabilities built in.

 
#### Open-source options:
- [Gmsh](https://gmsh.info): most versatile opensource meshing tool for CFD applications for structured and unstructured grids
- [FreeCAD](https://www.freecad.org): tool to generate CAD definition of the CFD domain, must be combined with a mesher to generate a CFD mesh
- [Salome](https://www.salome-platform.org): SMESH within this plateform is a full fledge meshing tool that can accomodate complex geomeries
- [blockMesh](https://www.openfoam.com/documentation/user-guide/4-mesh-generation-and-conversion/4.3-mesh-generation-with-the-blockmesh-utility): a utility within the openFoam framework to generate structured meshes
- [snappyHexMesh](https://www.openfoam.com/documentation/user-guide/4-mesh-generation-and-conversion/4.4-mesh-generation-with-the-snappyhexmesh-utility): a utility within the openFoam framework to generate an unstructured mesh around an arbitrarily complex CAD geometry
- [meshio](https://github.com/nschloe/meshio): although formally not a meshing tool, this software can translate mesh files among many different mesh formats

### Commercial tools
- [Pointwise](https://www.pointwise.com)
- [Cubit](https://coreform.com/products/coreform-cubit/gambit/)
- [Autodesk](https://www.autodesk.com/solutions/cad-software)
- integrated meshers within commercial packages (e.g.  [Ansys Meshing](https://www.ansys.com/training-center/course-catalog/fluids/introduction-to-ansys-meshing-cfd), [StarCCM+ Mesher](https://plm.sw.siemens.com/en-US/simcenter/fluids-thermal-simulation/star-ccm/) )


For this course, we focus on [Gmsh](https://gmsh.info) which is a highly versatile open-source mesher that can create structured or unstructured grid. It can also natively or near-natively output in a number well-known meshing formats.


##  Construct the geometry
For complex geometries, for example pumps, industrial applications, or  building fluid dynamics, the geometry of the simulation domain should be generated in a dedicated CAD software. This facilitates parametrisation of the geometry as these tools are better adapted to typical CAD workflow.  For very simple geometries, many of the existing meshing tools have the limited abilities to create geometries and can be used.



## Generate mesh
Once the geometry is generated, the fluid domain can be discretized for the CFD computation. 



### Deciding the type of mesh to use

Structured vs unstructured


** Structured mesh generation **
Smaller storage and memory needs
Better accuracy
Lower computational cost
Potentially faster computations


** CONs **
- Can result in more grid points: by construct, we may have unnecessary grid points due to the need to have a structured mesh
- Inability to mesh complex geometries


** Unstructured mesh generation **



[Example of storage requirement in structured vs unstructured]





### How to generate the mesh





gmsh -2 -setnumber domain_size 1.0 source/square.geo -o ./square.msh

Discussion reconstructParMesh for openFoam




## Configure numerical setup





## Example: Grid generation
For this example, we use the opensource meshing software [Gmsh](https://gmsh.info) to discretize domain.  Other open-source meshing alternatives are found directly in OpenFoam's [blockMesh](https://www.openfoam.com/documentation/user-guide/4-mesh-generation-and-conversion/4.3-mesh-generation-with-the-blockmesh-utility) or with [Salome](https://www.salome-platform.org/?page_id=374)


<Tabs group="tab-group">
    <TabItem label="Code">
        ```python title="hwmpi.py"
        # Hellow world in parallel

        from mpi4py import MPI

        comm = MPI.COMM_WORLD
        worker = comm.Get_rank()
        size = comm.Get_size()

        print("Hello world from worker ", worker, " of ", size)
        ```
    </TabItem>
    <TabItem label="Run command">
<CodeFetch rawURL='https://raw.githubusercontent.com/ARC4CFD/arc4cfd/dev/section1/isleap.py' lang='python' meta="title='isleap.py'" />

    </TabItem>
</Tabs>





Mesh for the domain is generated using gmsh. 3 sets of mesh corresponding to varying y+ values are generated for the simulation. The boundary layer is modeled using SA turbulence model and the first cell y+ value in the models are constrained within 5. Table 1 gives the list of mesh and time step parameters considered for each y+ cases. Meshed domains are shown in Figs. 2-4. 
![HPCcompromise.](../../../assets/figs_section2/ARC4CFD_workflow_HPC.png "Optimize HPC costs of the CFD simulation")




## Example: Simulation setup
Standard SA model is used for near-wall turbulence modeling while Smagorinsky LES sub-grid scale (SGS) model is implemented at wall-normal distances larger than a value specified from default wall-distance coefficient. (Refer to Molina et al (2017) for SU2 formulations). 
In SU2, 2nd order dual-time stepping scheme is used for time marching method with 5 inner iterations per time step. Total simulation duration is 400ms which corresponds to roughly 10 flow passes across stream wise direction. Results are saved every 2ms. 


:::note[Learning Objectives]
Having finished this lecture, you should now be able to answer the following important questions:
1. XXXXXX
:::
