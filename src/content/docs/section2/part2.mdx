---
title: Plan the simulation

bibliography: references_zotero_JPH-2.bib
---


:::note[Learning Objectives]
By the end of this section, you should be able to:
1. Setup a methodology to determine key simulation parameters
2.  Determine variables of interest 
:::
import Caption from '../../../components/Caption.astro';
import CustomAside from '../../../components/CustomAside.astro';
import Gif from '../../../components/Gif.astro';

import { Tabs, TabItem } from '@astrojs/starlight/components';
import { CardGrid } from '@astrojs/starlight/components';
import Option from '../../../components/Option.astro';
import MultipleChoice from '../../../components/MultipleChoice.astro';
import Box from '../../../components/Box.astro';
import Spoiler from '../../../components/Spoiler.astro';
import CustomIcon from '../../../components/CustomIcon.astro';

## Planning CFD simulations on HPC: Overview
Constrained by finite HPC resources, the systematic planning of large-scale CFD simulations helps to best align the available resources to the scientific or engineering question that motivates the  CFD simulations. The planing in CFD is case specific, this section explores the various parameters influencing HPC cost and introduces an example CFD problem that will be used in the following classes.
![HPCcompromise.](../../../assets/figs_section2/ARC4CFD_workflow_PLAN.png "Planning of the CFD simulation")



## Parameters that influence HPC cost
The overall HPC cost of a large-scale CFD simulation will be driven by three main categories of considerations, these are related to:

- **Physics and CFD setup** 
	* *Dimensionality of the problem*
	* *Unsteadiness*
	* *Geometric complexity of CFD*
	* *Physics of the problem (inclusing multiphysics, multiphase, and/or multispecies)*
	* *Physical time advancement needed*
	* *Extent of the computational domain*
	* *Thermodynamic modelling*

- **Simulation parameters**
	* *Type of turbulence modeling* (*e.g.* RANS, LES, DNS)
	* *Order of numerical methods* 
	* *Convergence criteria*
	* *Type of boundary condition*
	* *Wall-resolved or wall modelled*
	* *Moving/deforming mesh, mesh adaptation etc.*
	
- **Parametric space**
	* *Number of simulations needed to cover the parametric space*

Each of the above categories of consideration is explored in more depth below:


### How to determine the physics and CFD setup?
The physical setup of the problem plays the largest role in the overall computational cost of the CFD.  Determining the level of abstraction of the CFD setup as well as the necessary physics that should be simulated is a critical aspect in the planning stage of a simulation.   Significant computational saving can be gained by simulating either a steady or a lower dimensional order problem, yet these considerations need to take into account a number of key factors which necessarily involves a good understanding of the fluid dynamics of the problem under consideration. It's clear that the physics and CFD setup is highly problem specific, but also depends on other externalities such as: expertise of the user, features/capabilities in the CFD solvers, ressources and time available. In this subsection, we explore the main parameter influencing the CFD setup


##### Dimensionality of the problem
The dimensionality of the problem is an important consideration that can greatly impact the computational time of a simulation. Consider a three-dimensional simulation that is dicretized with  $64\times 64\times 64$ grid points (or 262,144 grid points). If this simulation were able to be solved in two- instead of three-dimensions, the total number of grid points would drop by 64 times! ($64\times 64=4,096$) for a same resolution!  This great computational saving may not always be possible:

* Many problems are inherently three-dimensional and cannot be modelled as a two-dimensional problem (flow through pump or dispersion of pollutants, for example). 
* Turbulence is inherently three dimensional. Reynolds Averaged Navier Stokes (RANS) models the impact of the unsteady turbulence on the mean flow, as such they can be used in a two-dimensional simulation; the applicability of LES or DNS in two-dimensions is more questionable.
* Only one component of vorticity can be represented in two-dimensions (instead of a full three-dimensional vector) and vortex stretching cannot occur (a key characteristic of turbulence).
* Heat or mass transfer may be poorly estimated in two dimensions.

The following illustration shows decaying isotropic turbulence simulated in a two- and three-dimensional domain (vorticity is shown). Note the very clear difference between the turbulence in both cases. 
<CardGrid>
	<Gif src='../../../assets/figs_section2/IsoTurb2D.gif' alt='' width='100%'/>
	<Gif src='../../../assets/figs_section2/IsoTurb3D.gif' alt='' width='100%'/>
</CardGrid>
{/* ![Conceptual utilization of CFD to answer scientific or engineering questions.](../../../assets/figs_section2/IsoTurb2D.gif   "Conceptual utilization of CFD to answer scientific or engineering questions.")  ![Conceptual utilization of CFD to answer scientific or engineering questions.](../../../assets/figs_section2/IsoTurb3D.gif   "Conceptual utilization of CFD to answer scientific or engineering questions.") */}
<Caption>Comparison between a 2D (left) and 3D (right) simulation of isotropic-like turbulence.</Caption>


##### Geometric complexity 
The reduction of the geometric complexity of the CFD  can significantly reduce the computational cost. Ultimately, we seek to omit or simplify any irrelevant geometrical details, yet determining what is *relevant* from what is *not* is challenging. The first question to ask is: *do we need to simulate the entire fluid dynamic problem under consideration?*  One good way to think of the problem of the required geometric complexity is to consider the following design space:
![HPCcompromise.](../../../assets/figs_section2/ARC4CFD_geometricComplexity.png "Planning of the CFD simulation")

In this figure, the ordinate goes from simulating the **building blocks** of the problem all the way to the **full scale model**.  For example, if our full-scale physical problem involves the heating an ventilation in a room, the building blocks of this problem could be, for example : a) the jet formed by the ventilation exhaust, b) the heat transfer at the wall, or c) the mixing of hot and cold air. On the second axis (abscissa)  we have, on one end, the **abstracted problem** and on the other the **applied problem**.  As an example, if we are interesting in exploring the laminar flow separation on an airfoil, the applied problem would be simulate the full airfoil at the desired conditions, and abstracted problem could be the study of flow separation on a smooth bump. In this case, we are abstracting the problem to better isolate the physics that are under consideration.  Naturally the discussion of modeling complexity go hand-in-hand with the fidelity of the modelling.


Now suppose we are interested in simulating an applied, full-scale problem. These problems tend to have a lot of geometric complexity (e.g. flow over a complex terrain wind-turbine farm, or the aerodynamics of an race car).  Most small-scale geometric complexity that of a system can be removed (e.g. rivet heads, grooves), if their influence is deemed to be negligeable.  These small geometric details require additional grid points to fully resolve, which are wasted computational resources if the details plays a negligeable role in the simulation results. If they are included without the necessary resolution, they can lead to an increased numerical error, local numerical instability, and/or can result in time-stepping limitations that can greatly penalize a large scale simulation. But more generally, determining which geometric details to omit is non-trivial and requires a good amount of experience, intuitition, and understanding of the numerical methods.



##### Physics of the problem 
A further consideration lies in determining the level of fidelity of the physical modelling needed in the CFD model. For example, if we are interested in modelling an aeroacoustic problem, then we naturally need to consider either resorting to an [aeroacoustic model](https://www.openfoam.com/industries/automotive-and-land-transportation/aeroacoustics) or resolving the acoustic wave propagation (typically very computationally demanding). These first-order considerations are typically very easy to determine, what is more challenging are the secondary physical considerations.


 For example, all matter--including a fluid--has a finite level of compressibility. The compressibility is defined by the bulk compressibility factor which is a ratio of the relative change in volume of the fluid per change in pressure: $k=1/V \frac{dV}{dp}$ (can be defined isothermally or isentropically).  But, if the relative change in volume (or we can of the change in density) for the pressure change in a given fluid system, we can greatly simplify the Navier-Stokes equation by considering a constant density, incompressible flow. In other simulations, we may want to consider pressure dependant, variable density flows (for example in atmospheric turbulence) that is still incompressible. Under other conditions, we may want to solve a low-Mach formulation that can allow for density fluctuations. The decision on which type of incompressible solver one uses is problem dependent and has a direct impact on the computational cost. Some of these formulations  involve very large linear systems which can be challenging to compute  on massively parallel HPC systems.


:::tip[Rule of thumb]
As a genaral rule, if the local Mach number is below 0.3, the compressibility effects will be negligible. Keep in mind that for simulations of, for example atmospheric flows, where the pressure and temperature vary with elevation, or in flows with large temperature variations, where the density changes with temperature, the Mach number-based delination is not effective. In these case, we can solve incompressible equations with variable density fluid.
:::


For compressible and non-isothermal flows, we must typically solve the conservation of energy equation (in addition to the mass and momentum conservation) which requires an additional state equation to relate the primitive thermodynamic variables.  By default, most CFD solvers assume a calorically perfect gas, which imposes constant specific heat and ideal gas law. For simulations that have non-ideal thermodynamics, for example using the Peng-Robinson state equation, the solution of the thermodynamic solver requires an iterative loop and imposes significant computation overhead.  [Milan et al. (2021)](https://www.sciencedirect.com/science/article/pii/S0021999121004629) noted that the species transport equations and thermodynamics took over 56% of the total computational cost for a non-ideal, combustion simulation. 
![Conceptual utilization of CFD to answer scientific or engineering questions.](../../../assets/figs_section2/ARC4CFD_combustionTime.png   "Relative computational time.")

Computational expense of a simulation can grow significantly by considering additional physics (multiphase flows, electro-fluid-dynamics) or by addition strong source terms (buoyancy, radiation, heat release).  One must consider the various impacts on the  modeling of the physics of the problem on the desired simulation outcomes.



####  Extent of computational and temporal domain  
The extent of both the computational domain and time domain will directly impact the overall HPC cost of a simulation. The computational domain size is primarily a consideration for external flows, although internal flows may also need to consider the computational domain size to simulate a fully developed pipe flow, for example. Ideally, we need to determine the minimal domain size (minimize computational cost) that allows us to simulate the problem without negative influence of the boundary conditions. Take the example of a plume exhausting from a stack below. Determining the minimal domain will depend on the problem.  [to continue]

![HPCcompromise.](../../../assets/figs_section2/ARC4CFD_plume.png "Competing aspects in setting up CFD simulations")
<Caption>Domain size consideration.</Caption>

Similarly, the extent of the temporal domain may also influence the overall simulation cost. 





### What are the considerations for the simulation parameters?
The choice of the simulation parameters will inherently be tied to some of the decisions taken in determining the CFD setup. 

#### Turbulence modeling
Although the turbulence modeling could have been included in the CFD setup discussed above, we chose to discuss this in the simulation parameters as these turbulence models can often by modified directly in the input files.  The detailed discussion on the turbulence models will be left for the next section, here we briefly discuss the main difference between RANS, LES, and DNS. 
![Conceptual utilization of CFD to answer scientific or engineering questions.](../../../assets/figs_section2/ARC4CFD_turbulence.png   "Relative computational time.")
[to do]



#### Order of the numerical scheme
The order of the spatial and temporal scheme will directly influence the computational time of the simulation. As a general rule, the higher the order, the fewer grid points (or time advancement) are needed for the same numerical error. Thus, we need to strick a compromise between the order of the schme

[Here also discuss implicit vs explicit schemes]



#### Boundary conditions

[]to do]






### What parameters space do I need to cover?
[to do]




## What do I need to resolve?
[to do]








<Box iconName='exercise'>
## EXAMPLE: Planning the simulation
We present an example that carries through the entire section and systematically apply the workflow and the concepts learned. For this example, we consider the study of a canonical NACA 4412 airfoil with a flap. This is a representative of a typical non-symmetric airfoil that could be encountered in many aerospace applications.
![NACA4412.](../../../assets/figs_section2/ARC4CFD_airfoil.png "Example CFD")
<Caption>Example of a NACA 4412 airfoil with a flap. </Caption>

In order to correctly plan the simulation, we must clearly identify the underlying scientific question that motivates the study. For this example, we are interested in **quantifying the buffeting effects caused by the gap between the airfoil and the flap**.  This question will motivate the entire application of this example in this course.  In order to start planning out the simulation, we need to align the physical problem, the scientific question and the abstracted CFD setup, as illustrated here:

![NACA4412.](../../../assets/figs_section2/ARC4CFD_alignmentExample.png "Example CFD")
<Caption>Example of the alignment between the physical problem, the scientific (or engineering) question and the CFD setup. </Caption>
The scientific question and physical problem are given in this case and we must determine the best abstracted CFD setup that is close enough to the actual physical setup  while allowing us to address the scientific question motivating this work. To help us determine the type of simulation needed, try to answer the following questions:

<Box imgSrc="/src/assets/quiz_icon.png">
#### Problem 1: Does this simulation need to be unsteady?
<MultipleChoice>
    <Option isCorrect>
        Yes
    </Option>
    <Option>
      No   
      </Option>
</MultipleChoice>

<details>
    <summary>Problem 1: Solution </summary>
The buffeting is an inherently **unsteady** phenomena, therefore the an unsteady simulation is  needed to capture this effect without resorting to additionally modelling. 
</details>


#### Problem 2: Does this simulation need to be three-dimensional?
<MultipleChoice>
    <Option >
        Yes
    </Option>
    <Option>
      No   
      </Option>
          <Option isCorrect>
      Maybe
      </Option>
</MultipleChoice>

<details>
    <summary>Problem 2: Solution </summary>
   This flow is likely turbulent and is characterized by spanwise aligned turbulent structures. 
   
    These structures are inherently three-dimensional, so ideally a [todo]
       </details>

</Box>

The above questions guide us towards the need to simulate an unsteady, three-dimensional problem. Now comes the question of the necessary geometric complexity of the CFD setup. This question is intrinsically tied to the modelling fidelity needed for to answer the scientific question. Another way to think of it, if we had unlimited computational ressources, we would simulate the entire airfoil (hey, while we are at it, why not simulate the full airplane!) in all its geometric complexity. Under finite computational resources, we must align the geometric complexity and modeling fidelity of the problem.

To better visualize this complexity, we can explore the possible geometric configurations on a two-dimensional space. The first axis (ordinate) goes from simulating the **building blocks** of the problem all the way to the **full scale model** (full airfoil). The second axis (abscissa) we have, on one end, the **abstracted problem** and on the other the **applied problem**. To better visualize the problem, we rotated the axes and provided examples possible geometries to consider: 





![CFD Example.](../../../assets/figs_section2/airfoil4412wflap_example.png "Example CFD")
<Caption>Example of geometric and modeling fidelity matrix for the NACA 4412 airfoil with a flap. </Caption>
For the present course, the focus of the study lies in a higher-fidelity simulation in order to explore buffeting effects at the gap while leveraging HPC resources. As a result, there are multiple geometries that could be study. Here, we will focus on the backward facing step (BFS). BFS is characterized by a recirculation flow with a strong shear layer.  


### Problem description: backward facing step
Here we simulate a BFS of height, $\delta$ , is subject to a freestream flow at velocity $U$.  The transient development of flow structure downstream of the step is simulated using incompressible solver at low-Reynolds number ($Re_h = \frac{\rho U \delta}{\mu}= 5000$).  
The flow domain is chosen based on the experimental work by [Jovic and Driver (1994)](https://link.springer.com/article/10.1007/BF00208471) and subsequent DNS studies by Le et al (1997). Schematic of the flow domain is shown below:
![CFD Example.](../../../assets/figs_section2/ARC4CFD_Exampledomain.png "Example CFD")
<Caption> Geometry of the simulation example. </Caption>


OpenFoam v23 and SU2 v7 are used to simulate the flow. 

</Box>

## References
1. https://www.osti.gov/servlets/purl/1889593
2. https://ntrs.nasa.gov/api/citations/20140003093/downloads/20140003093.pdf
3. https://www5.in.tum.de/lehre/vorlesungen/hpc/WS14/intro.pdf
